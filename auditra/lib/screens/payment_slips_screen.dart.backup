import 'package:flutter/material.dart';
import 'package:intl/intl.dart';
import 'package:shared_preferences/shared_preferences.dart';
import 'package:file_picker/file_picker.dart';
import 'dart:io';
import '../services/api_service.dart';
import '../models/payment_slip_model.dart';

class PaymentSlipsScreen extends StatefulWidget {
  final String? role;
  
  const PaymentSlipsScreen({super.key, this.role});

  @override
  State<PaymentSlipsScreen> createState() => _PaymentSlipsScreenState();
}

class _PaymentSlipsScreenState extends State<PaymentSlipsScreen> {
  List<PaymentSlip> _paymentSlips = [];
  List<PaymentSlip> _othersPaymentSlips = [];
  bool _isLoading = true;
  String? _userRole;
  int? _currentUserId;
  final TextEditingController _searchController = TextEditingController();
  String _searchQuery = '';
  
  // Roles that should have admin-style structure (left-aligned, black text, simple)
  final List<String> _leftAlignRoles = [
    'admin',
    'hr_staff',
  ];
  
  bool get _shouldAlignLeft {
    final role = _userRole ?? widget.role;
    return role != null && _leftAlignRoles.contains(role);
  }

  @override
  void initState() {
    super.initState();
    _loadUserRole();
    _loadPaymentSlips();
  }
  
  @override
  void dispose() {
    _searchController.dispose();
    super.dispose();
  }
  
  Future<void> _loadUserRole() async {
    if (widget.role == null) {
      final roleResult = await ApiService.getMyRole();
      if (roleResult['success'] && mounted) {
        setState(() {
          _userRole = roleResult['data']['role'];
        });
      }
    } else {
      _userRole = widget.role;
    }
    
    // Get current user ID for filtering
    final prefs = await SharedPreferences.getInstance();
    final userIdString = prefs.getString('user_id');
    if (userIdString != null) {
      _currentUserId = int.tryParse(userIdString);
    }
  }

  Future<void> _loadPaymentSlips() async {
    setState(() => _isLoading = true);

    try {
      // Check if user is admin - if so, load all payment slips and separate them
      final role = _userRole ?? widget.role;
      final isAdmin = role == 'admin';
      
      if (isAdmin) {
        // Load all payment slips (excluding admin's own)
        final allResult = await ApiService.getAllPaymentSlips();
        
        if (mounted) {
          setState(() {
            _isLoading = false;
            
            // Process all payment slips and filter out admin's own
            if (allResult['success']) {
              final allData = allResult['data'];
              List<PaymentSlip> allSlips = [];
              
              if (allData is List) {
                allSlips = allData.map((json) {
                  return PaymentSlip.fromJson(json as Map<String, dynamic>);
                }).toList();
              } else if (allData is Map && allData.containsKey('results')) {
                allSlips = (allData['results'] as List)
                    .map((json) => PaymentSlip.fromJson(json as Map<String, dynamic>))
                    .toList();
              }
              
              // Filter out ALL admin payment slips - admin should not see any admin slips
              // Exclude by role to ensure all admin slips are removed (regardless of userId)
              _othersPaymentSlips = allSlips.where((slip) {
                // Remove any payment slip where role is 'admin'
                return slip.role != 'admin';
              }).toList();
              
              // Set _paymentSlips to empty for admin (they only see others)
              _paymentSlips = [];
            } else {
              _othersPaymentSlips = [];
              _paymentSlips = [];
            }
          });
        }
        return;
      }
      
      // For non-admin users, load only their own payment slips
      final result = await ApiService.getMyPaymentSlips();

      if (mounted) {
        setState(() {
          _isLoading = false;
          if (result['success']) {
            final data = result['data'];
            try {
              if (data is List) {
                _paymentSlips = data.map((json) {
                  try {
                    return PaymentSlip.fromJson(json as Map<String, dynamic>);
                  } catch (e) {
                    print('Error parsing payment slip item: $e');
                    print('Item data: $json');
                    rethrow;
                  }
                }).toList();
              } else if (data is Map && data.containsKey('results')) {
                _paymentSlips = (data['results'] as List)
                    .map((json) {
                      try {
                        return PaymentSlip.fromJson(json as Map<String, dynamic>);
                      } catch (e) {
                        print('Error parsing payment slip item: $e');
                        print('Item data: $json');
                        rethrow;
                      }
                    })
                    .toList();
              } else {
                // Handle case where data might be directly a list
                _paymentSlips = [];
              }
            } catch (e) {
              print('Error processing payment slips data: $e');
              _paymentSlips = [];
              rethrow;
            }
          } else {
            _paymentSlips = [];
            // Silently handle error - don't show error message
          }
        });
      }
    } catch (e) {
      if (mounted) {
        setState(() {
          _isLoading = false;
          _paymentSlips = [];
        });
        // Silently handle error - don't show error message
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final role = _userRole ?? widget.role;
    final isAdmin = role == 'admin';
    
    return Scaffold(
      appBar: AppBar(
        title: Text(isAdmin ? 'All Payment Slips' : 'Payment Slips'),
        centerTitle: true,
      ),
      body: _isLoading
          ? const Center(child: CircularProgressIndicator())
          : (isAdmin 
              ? _othersPaymentSlips.isEmpty 
              : _paymentSlips.isEmpty)
              ? Center(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      Icon(Icons.payment, size: 64, color: Colors.grey[400]),
                      const SizedBox(height: 16),
                      Text(
                        'No payment slips found',
                        style: TextStyle(
                          fontSize: 18,
                          color: Colors.grey[600],
                        ),
                      ),
                      const SizedBox(height: 8),
                      Text(
                        'Payment slips will appear here once admin uploads them',
                        style: TextStyle(
                          fontSize: 14,
                          color: Colors.grey[500],
                        ),
                        textAlign: TextAlign.center,
                      ),
                    ],
                  ),
                )
              : RefreshIndicator(
                  onRefresh: _loadPaymentSlips,
                  child: isAdmin
                      ? _buildAdminView()
                      : ListView.builder(
                          padding: const EdgeInsets.all(16.0),
                          itemCount: _paymentSlips.length,
                          itemBuilder: (context, index) {
                            final slip = _paymentSlips[index];
                            return _buildPaymentSlipCard(slip, isAdmin);
                          },
                        ),
                ),
    );
  }

  Widget _buildAdminView() {
    // Filter payment slips based on search query (only others, not admin's own)
    // Double-check to ensure NO admin payment slips are displayed
    final filteredSlips = _searchQuery.isEmpty
        ? _othersPaymentSlips.where((slip) => slip.role != 'admin').toList()
        : _othersPaymentSlips.where((slip) {
            // Ensure role is not admin AND matches search query
            if (slip.role == 'admin') return false;
            final employeeNumber = slip.employeeNumber ?? slip.userId.toString();
            return employeeNumber.toLowerCase().contains(_searchQuery.toLowerCase());
          }).toList();
    
    return ListView(
      padding: const EdgeInsets.all(16.0),
      children: [
        // Search Bar
        Container(
          margin: const EdgeInsets.only(bottom: 16.0),
          decoration: BoxDecoration(
            color: Colors.grey[100],
            borderRadius: BorderRadius.circular(12),
            border: Border.all(color: Colors.grey[300]!),
          ),
          child: TextField(
            controller: _searchController,
            decoration: InputDecoration(
              hintText: 'Search by Employee Number',
              prefixIcon: const Icon(Icons.search, color: Colors.grey),
              suffixIcon: _searchQuery.isNotEmpty
                  ? IconButton(
                      icon: const Icon(Icons.clear, color: Colors.grey),
                      onPressed: () {
                        _searchController.clear();
                        setState(() {
                          _searchQuery = '';
                        });
                      },
                    )
                  : null,
              border: InputBorder.none,
              contentPadding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
            ),
            onChanged: (value) {
              setState(() {
                _searchQuery = value;
              });
            },
          ),
        ),
        
        // All Payment Slips (excluding admin's own - ensure no admin slips are displayed)
        ...filteredSlips.where((slip) => slip.role != 'admin').map((slip) => _buildPaymentSlipCard(slip, true)),
        
        // No results message
        if (_searchQuery.isNotEmpty && filteredSlips.isEmpty)
          Center(
            child: Padding(
              padding: const EdgeInsets.all(32.0),
              child: Column(
                children: [
                  Icon(Icons.search_off, size: 64, color: Colors.grey[400]),
                  const SizedBox(height: 16),
                  Text(
                    'No payment slips found',
                    style: TextStyle(
                      fontSize: 18,
                      color: Colors.grey[600],
                    ),
                  ),
                  const SizedBox(height: 8),
                  Text(
                    'No employee found with number: $_searchQuery',
                    style: TextStyle(
                      fontSize: 14,
                      color: Colors.grey[500],
                    ),
                  ),
                ],
              ),
            ),
          ),
      ],
    );
  }